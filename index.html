<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div>
        <label for="myfile">Select files:</label>
        <input type="file" id="files" name="files" multiple>
        <div id="chat-container">
        
        </div>
    </div>
    <script src='lib/whatapp-chat-parser.js'></script>
    <script>
	    
        let filesInput = document.getElementById('files');

        const files = {};
        const users = [];

        let parsedMessages;
        let parsedFiles;
        
        filesInput.addEventListener("change", async () => {

                const parser = WhatsAppChatParser();
                const whatsAppChat = await parser.start(filesInput);                
                console.log(whatsAppChat);
                const {messages, users, files} = whatsAppChat;

                for(parsedMessage of messages) {
                    let chatContainer = document.getElementById('chat-container');
                    let divChat = document.createElement('div');
                    divChat.innerText = parsedMessage.text;

                    for(file of parsedMessage.files) {
                        console.log(file);
                        console.log(files);
                        console.log(files[file]);
                        if(files[file].type.includes('audio')) {
                            const audio = document.createElement('audio');
                            audio.setAttribute('controls', true);

                            const source = document.createElement('source');
                            source.setAttribute('src', files[file].data);
                            source.setAttribute('type', files[file].type);

                            audio.appendChild(source);
                            divChat.appendChild(audio);

                        } else if(files[file].type.includes('video')) {
                            const video = document.createElement('video');
                            video.width = 320;
                            video.height = 240;
                            video.controls = true;
                            video.autoplay = true;
                            video.loop = true;
                            video.muted = true;

                            const source = document.createElement('source');
                            source.src = files[file].data;
                            source.type = files[file].type;

                            video.appendChild(source);
                            divChat.appendChild(video);
                        } else if(files[file].type.includes('image')) {
                            const image = document.createElement('img');
                            image.src = files[file].data;
                            image.width = 320;
                            image.height = 240;
                        }

                    }

                    for(user of users) {
                        if(user.name == parsedMessage.user)
                            divChat.style = `background-color: ${user.color}`;
                    }
                    
                    chatContainer.appendChild(divChat);
                
                }

			});

    </script>

</body>
</html>